<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nordia POS - Deployed</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- Header -->
    <header class="bg-green-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-white text-green-600 rounded flex items-center justify-center font-bold">N</div>
                <h1 class="text-2xl font-bold">Nordia POS</h1>
            </div>
            <div class="text-sm">Sistema de Punto de Venta - DEPLOYED ‚úÖ</div>
        </div>
    </header>

    <div class="container mx-auto p-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Productos -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <span class="mr-2">üì¶</span>
                        Productos
                    </h2>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="products-grid">
                        <!-- Se cargan din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Carrito -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <span class="mr-2">üõí</span>
                        Carrito
                    </h2>

                    <div class="space-y-3 mb-4 max-h-96 overflow-y-auto" id="cart-items">
                        <p class="text-gray-500 text-center py-8">Carrito vac√≠o</p>
                    </div>

                    <!-- Total -->
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center text-xl font-bold">
                            <span>Total:</span>
                            <span class="text-green-600" id="total">$0</span>
                        </div>
                    </div>

                    <!-- M√©todo de pago -->
                    <div class="mt-4 space-y-2">
                        <label class="text-sm font-medium text-gray-700">M√©todo de pago:</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setPaymentMethod('cash')"
                                    class="p-2 rounded border text-center payment-method active"
                                    data-method="cash">
                                <div class="text-lg">üíµ</div>
                                <div class="text-xs mt-1">Efectivo</div>
                            </button>
                            <button onclick="setPaymentMethod('card')"
                                    class="p-2 rounded border text-center payment-method"
                                    data-method="card">
                                <div class="text-lg">üí≥</div>
                                <div class="text-xs mt-1">Tarjeta</div>
                            </button>
                            <button onclick="setPaymentMethod('mercadopago')"
                                    class="p-2 rounded border text-center payment-method"
                                    data-method="mercadopago">
                                <div class="text-xs font-bold text-blue-600">MP</div>
                                <div class="text-xs mt-1">MercadoPago</div>
                            </button>
                        </div>
                    </div>

                    <!-- Email cliente -->
                    <div class="mt-4">
                        <label class="text-sm font-medium text-gray-700">Email cliente (opcional):</label>
                        <input type="email" id="customer-email" placeholder="cliente@email.com"
                               class="w-full mt-1 p-2 border rounded-lg">
                    </div>

                    <!-- Bot√≥n de cobrar -->
                    <button onclick="processSale()" id="pay-button"
                            class="w-full mt-4 py-3 px-4 rounded-lg font-semibold transition-all bg-gray-300 text-gray-500 cursor-not-allowed">
                        üí≥ COBRAR $0
                    </button>
                </div>
            </div>
        </div>

        <!-- Status del Backend -->
        <div class="mt-6">
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-lg font-semibold mb-2">Estado del Sistema</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <div id="backend-status" class="text-2xl mb-2">‚è≥</div>
                        <div class="text-sm">Backend API</div>
                        <div class="text-xs text-gray-500">Puerto 8003</div>
                    </div>
                    <div class="text-center">
                        <div id="frontend-status" class="text-2xl mb-2">‚úÖ</div>
                        <div class="text-sm">Frontend</div>
                        <div class="text-xs text-gray-500">HTML Est√°tico</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado global
        let products = [];
        let cart = [];
        let paymentMethod = 'cash';
        let loading = false;

        // API Base URL
        const API_BASE = 'http://localhost:8003';

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            checkBackendHealth();
            fetchProducts();
        });

        // Verificar salud del backend
        async function checkBackendHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();

                if (data.status === 'healthy') {
                    document.getElementById('backend-status').textContent = '‚úÖ';
                } else {
                    document.getElementById('backend-status').textContent = '‚ùå';
                }
            } catch (error) {
                console.error('Backend no disponible:', error);
                document.getElementById('backend-status').textContent = '‚ùå';
            }
        }

        // Cargar productos
        async function fetchProducts() {
            try {
                const response = await fetch(`${API_BASE}/api/products`);
                products = await response.json();
                renderProducts();
            } catch (error) {
                console.error('Error cargando productos:', error);
                // Productos de fallback
                products = [
                    { id: 1, name: 'Caf√©', price: 850, stock: 100, category: 'Bebidas' },
                    { id: 2, name: 'Medialunas', price: 450, stock: 50, category: 'Panader√≠a' },
                    { id: 3, name: 'Tostado', price: 1200, stock: 30, category: 'Sandwiches' },
                    { id: 4, name: 'Jugo Natural', price: 600, stock: 45, category: 'Bebidas' },
                ];
                renderProducts();
            }
        }

        // Renderizar productos
        function renderProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = products.map(product => `
                <button onclick="addToCart(${product.id})"
                        ${product.stock === 0 ? 'disabled' : ''}
                        class="p-4 rounded-lg border-2 transition-all ${
                            product.stock > 0
                                ? 'border-gray-200 hover:border-green-500 hover:shadow-md'
                                : 'border-gray-200 bg-gray-100 cursor-not-allowed opacity-50'
                        }">
                    <div class="text-lg font-medium">${product.name}</div>
                    <div class="text-green-600 font-bold mt-2">${formatPrice(product.price)}</div>
                    <div class="text-sm text-gray-500 mt-1">Stock: ${product.stock}</div>
                    ${product.category ? `<div class="text-xs bg-gray-100 rounded px-2 py-1 mt-2">${product.category}</div>` : ''}
                </button>
            `).join('');
        }

        // Agregar al carrito
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock === 0) return;

            const existingItem = cart.find(item => item.id === productId);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }

            renderCart();
        }

        // Remover del carrito
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            renderCart();
        }

        // Actualizar cantidad
        function updateQuantity(productId, delta) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;

            item.quantity += delta;
            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                renderCart();
            }
        }

        // Renderizar carrito
        function renderCart() {
            const cartEl = document.getElementById('cart-items');
            const totalEl = document.getElementById('total');
            const payButton = document.getElementById('pay-button');

            if (cart.length === 0) {
                cartEl.innerHTML = '<p class="text-gray-500 text-center py-8">Carrito vac√≠o</p>';
                totalEl.textContent = '$0';
                payButton.className = 'w-full mt-4 py-3 px-4 rounded-lg font-semibold transition-all bg-gray-300 text-gray-500 cursor-not-allowed';
                payButton.innerHTML = 'üí≥ COBRAR $0';
                return;
            }

            cartEl.innerHTML = cart.map(item => `
                <div class="border-b pb-3">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-medium">${item.name}</div>
                            <div class="text-sm text-gray-500">${formatPrice(item.price)} x ${item.quantity}</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="updateQuantity(${item.id}, -1)"
                                    class="p-1 rounded bg-gray-200 hover:bg-gray-300 w-6 h-6 flex items-center justify-center text-sm">-</button>
                            <span class="w-8 text-center">${item.quantity}</span>
                            <button onclick="updateQuantity(${item.id}, 1)"
                                    class="p-1 rounded bg-gray-200 hover:bg-gray-300 w-6 h-6 flex items-center justify-center text-sm">+</button>
                            <button onclick="removeFromCart(${item.id})"
                                    class="p-1 rounded bg-red-100 hover:bg-red-200 text-red-600 w-6 h-6 flex items-center justify-center text-sm">√ó</button>
                        </div>
                    </div>
                    <div class="text-right font-semibold text-green-600 mt-1">${formatPrice(item.price * item.quantity)}</div>
                </div>
            `).join('');

            const total = calculateTotal();
            totalEl.textContent = formatPrice(total);
            payButton.className = 'w-full mt-4 py-3 px-4 rounded-lg font-semibold transition-all bg-green-600 text-white hover:bg-green-700';
            payButton.innerHTML = `üí≥ COBRAR ${formatPrice(total)}`;
        }

        // Calcular total
        function calculateTotal() {
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        }

        // Formatear precio
        function formatPrice(price) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS'
            }).format(price);
        }

        // Cambiar m√©todo de pago
        function setPaymentMethod(method) {
            paymentMethod = method;
            document.querySelectorAll('.payment-method').forEach(btn => {
                btn.classList.remove('active', 'border-green-500', 'bg-green-50');
                btn.classList.add('border-gray-200');
            });

            const selected = document.querySelector(`[data-method="${method}"]`);
            selected.classList.add('active', 'border-green-500', 'bg-green-50');
            selected.classList.remove('border-gray-200');
        }

        // Procesar venta
        async function processSale() {
            if (cart.length === 0 || loading) return;

            loading = true;
            const payButton = document.getElementById('pay-button');
            payButton.innerHTML = 'Procesando...';

            const saleData = {
                items: cart.map(item => ({
                    product_id: item.id,
                    product_name: item.name,
                    quantity: item.quantity,
                    unit_price: item.price,
                    subtotal: item.price * item.quantity
                })),
                total: calculateTotal(),
                payment_method: paymentMethod,
                customer_email: document.getElementById('customer-email').value || 'cliente@nordia.com'
            };

            try {
                const response = await fetch(`${API_BASE}/api/sales`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(saleData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ Venta exitosa! ID: ${result.sale_id}`);
                    cart = [];
                    renderCart();
                    fetchProducts(); // Actualizar stock
                } else {
                    alert('‚ùå Error procesando la venta');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n con el servidor');
            } finally {
                loading = false;
                payButton.innerHTML = `üí≥ COBRAR ${formatPrice(calculateTotal())}`;
            }
        }

        // CSS para m√©todo de pago activo
        const style = document.createElement('style');
        style.textContent = `
            .payment-method.active {
                border-color: #10b981 !important;
                background-color: #f0fdf4 !important;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>